<div dir="rtl">
  
# راه اندازی و کانفیگ logstash
  
  
  از ایجنت logstash برای دریافت لاگ کانتینر های داکر با کمک گرفتن از 
  یکی از لاگ درایور های داکر به نام `gelf` استفاده خواهیم کرد.
  
  ## دیزاین
  دیزاین و آرشیتکت کلی logstash با استفاده از نمودار زیر شرح داده میشود.
    ![logstash diagram](https://user-images.githubusercontent.com/77579794/133299933-e75b31ee-73c7-4064-a395-322d834aaf80.png)
  
  1. کانتینر هدف میتواند داخل یا خارج از نتورک داکری باشد که کانتینر logstash  حضور دارد واین مورد اصلا مهم نیست و تمامی لاگ های ارسالی 
  توسط gelf 
  ابتدا به هاست اصلی بر روی پورت 12201 فرستاده میشود و سپس توسط docker-proxy به پورت 12201 کانتینر لاگ استش میرسد.
  
  2. در نتیجه از مورد قبلی همچنین میتواند لاگ کانتینر هایی که در هاستی خارج از هاست agent  ما حضور دارند نیز ارسال کرد.
  این کانفیگ مربوط به کانفیگ `gelf output` میباشد که در ادامه در موردش توضیح داده خواهد شد.
  
  3. در نهایت لاگ های جمع آوری شده در کانتینر لاگ استش پراسس میشوند و در این مرحله برای `elasticsearch output` ارسال خواهند شد.
  
  ## کانفیگ
  
  مسیر فایل های کانفیگ و راه اندازی مربوطه به logstash در مسیر /elk-dockerized/docker-compose/logstash قرار دارد و هر مسیری در ادامه گفته میشود relative به این مسیر میباشد.
  
  دو فایل کانفیگ برای logstash در نظر گرفته شده است که به صورت bind-mount در اختیار کانتینر گذاشته خواهند شد.
  
  در مسیر `data/config/logstash.yml` کانفیگ پیکربندی logstash قرار دارد.
  کافیست فقط دایرکتیو زیر را با ادرس مربوط به هاست `elasticsearch` خود و روی پورت مربوط به elasticsearch تغییر دهید.
    <pre dir="ltr">
  monitoring.elasticsearch.hosts: [ "https://elk.mohsenkamini.ir:9200" ]
   </pre>
  
  فایل بعدی مربوط به کانفیگ `pipeline` لاگ استش میباشد که مواردی همچون:
  
  - `input` ها برای نحوه دریافت لاگ ها
  
  - `filter` ها برای پراسس کردن و عملیات روی لاگ ها
  
  - و `output` برای تعیین محل ارسال لاگ های دریافت و پراسس شده که ما از اوتپوت `elasticsearch` استفاده میکنیم.
  
  نگاهی بیاندازیم به کانفیگ های باید برای استک شما شخصی سازی شوند.
      <pre dir="ltr">
output {
  elasticsearch {
    hosts => ["https://elk.test.ir:9200"]
    user => "elastic"
    password => "CHANGEME"
    index => "logstash-7.14.0"
  }
}
   </pre>
   در این قسمت همان طور که مشخص شده باید credentials مربوطه را برای یوزر elastic  وارد کنید و همچنین هاست مربوط به elasticsearch را تغییر دهید.

  
  
  
  </div>
