<div dir="rtl">
 
# مقدمه

 این ریپازیتوری جهت راه اندازی و نصب استک elk 
 تهیه شده است. 
 elk
 ابزاری برای مدیریت متمرکز log های سرویس ها و سرور های شماست.
 
نوشته شده توسط _محسن کربلائی امینی_  |  نئورکلود  |  سپتامبر 2021
 
 # چکیده
 
 نصب راه اندازی این استک را به دو قسمت مجزا تقسیم بندی میکنیم.
 
 1. [راه اندازی استک کلی و پایه `elastcisearch & Kibana`](#راه-اندازی-استک-کلی-و-پایه-elastcisearch--kibana)
 2.  [راه اندازی `Agent` ها ](#راه-اندازی-agent-ها)
 ---
 ## راه اندازی استک کلی و پایه `elastcisearch & Kibana`
 
 در قسمت مرکزی استک منیجر اصلی `elasticsearch` و `kibana` حضور دارند.
 
 `kibana` نقشی مانند گرافانا را ایفا خواهد کرد و برای visualization مورد استفاده قرار خواهد گرفت. 
 لذا افزودن `replica` دیگر یا ورکر جدیدی را برای آن متصور نیستیم.
 
 `elasticsearch` هسته مرکزی و اصلی استک ماست و عملیات دریافت لاگ ها و انجام پراسس های مختلف روی آنها که در نهایت به آماده سازی لاگ ها 
 جهت `queriablity` و قابل نمایش بودن بر عهده ی الستیک و ورکر های آن میباشد.
 
 البته در سناریو فعلی این دو در کنار هم هستن, طبعا در اسکیل های بالاتر امکان اضافه کردن ورکر های الستیک روی نود های خارجی و دیگر طرح ها و دیزاین ها عملی ست. در سناریو  این ریپازیتوری در حال حاضر از یک هسته اصلی الستیک و یک ورکر روی همان نود استفاده میشود.
 
 ### توضیح دیزاین نود مرکزی ELK
 
 با استفاده از چارت زیر به آرکیتک نود مرکزی میپردازیم. به شماره گذاری توجه کنید:
 
 ![ELK base diagram - numbered](https://user-images.githubusercontent.com/77579794/133118238-baf0f569-61bd-43a7-9e6d-3061d7e4037c.png)
 
 1. رکوئست های از طرف کاربر برای مشاهده پنل اصلی `kibana` روی پورت
 `443`
 برای دامنه که بعدا نشان خواهیم داد چطور تعیین و کانفیگ میشود ارسال میشود. این درخواست توسط `docker-proxy`
 برای کانتینر `nginx`
 که نقش `reverse proxy`
 را برای شبکه داخلی داکر با نام (`es_elastic`)
 ایفا میکند, ارسال میشود.
 
 2. کانتینر `nginx` به همراه کانتینر `certbot` وظیفه دریافت و تجدید گواهی `SSL` برای دامنه ما  را دارند
 بدین ترتیب هر رکوئستی که قرار باشد به داخل نتورک راه پیدا کند باید `https` باشد.
 
 3. رکوئستی که برای پورت 
 `443` ارسال شده بود
 توسط `nginx`
 به پورت 
 `5601`
 کانتینر `kibana` پراکسی میشود. 
 همان طور که در شکل مشخص هست, هیچ پورتی از کانتینر `kib01` روی هاست باز نمیباشد. و تنها راه ورودی از کانتینر `nginx` میباشد.
 به این ترتیب کاربر به پنل `kibana` دسترسی پیدا میکند.
 
 4. حال باید ببینیم که `log` ها یا `metric` های مختلف که از ریجن های مختلف, کانتینر ها و دیگر موارد جمع آوری میشود چگونه به دست `elasticsearch` مرکزی میرسد.
 هر کدام از `Agent` های مورد نظر, نظیر `filebeat` یا `logstash`
 باید درخواست ها و اطلاعات مربوطه جمع آوری شده را به پورت 
 `9200` 
 بر روی دامنه اصلی که به آیپی ماشین اصلی ریزالو شده بفرستد.
 
 اینجا هم مانند برقراری ارتباط کاربر با پنل `kibana` رکوئست از `reverse proxy` گذشته و به صورت `https`
 در مرحله **5** به دست `elasticsearch` یا کانتینر مرکزی که 
 `es01` باشد میرسد.
 
 6. در نهایت ارتباط بین `kibana` و `elasticsearch` در این مرحله با توجه به کانفیگ های صورت گرفته برای `kibana` انجام میگیرد.
 
 - نکته : ارتباطات `https` ای در نتورک داخلی داکر به صورت `self signed`  صورت میپذیرد که کانفیگ های مربوطه به آن در لیست فایل های زیر صورت گرفته است.
  <pre dir="ltr">
  instances.yml
  docker-compose.yml
  create-certs.yml
  </pre>
 
 حال باید ببینیم که کانفیگ و راه اندازی هر بخش این استک چگونه صورت میگیرد.
 ### راه اندازی و کانفیگ elastic و kibana
 یکی از مهم ترین کانفیگ هایی که برای استک داریم, ورژن کامپوننت های الستیکی میباشد(الستیک, کیبانا و agent ها )
 تمامی این ورژن ها باید هماهنگ و یکسان باشند. این کانفیگ برای الستیک و کیبانا درون فایل `.env` در مسیر `/elk-dockerized/docker-compose` تعیین میشود. 
 در زمان نوشتن این داکیومنت آخرین ورژن الستیک 7.14.0 بوده و در صورت نیاز میتواند آن را تغییر دهید, اما مهم هست که بیاد داشته باشید این تغییر ورژن ممکن است در ادامه راه اندازی مسیر متفاوتی از آنچه در این داکیومنت میبینید برایتان رقم بزند.
 
 کانفیگ اصلی کیبانا در مسیر `elk-dockerized/docker-compose/data/kibana/kibana.yml` قابل دسترسی ست.
 دو دایرکتیو اصلی در این فایل وجود دارند که مربوط به دامنه شماست. برای تغییر آن دامنه خود را در کامند زیر جایگذاری کنید:
   <pre dir="ltr">
cd elk-dockerized/docker-compose/
sed -i 's/elk.test.ir/YOUR-DOMAIN/g' ./data/kibana/kibana.yml
  </pre>
 
 حالا زمان بالا آوردن اولیه کیبانا و الستیک سرچ میباشد.
 
 - نکته: پیشنهاد میشود قبل از اجرای این اسکریپت `docker login` کنید تا با ارور rate limit برخورد نکنید.
 
 - مطمئن شوید هم برای هاست خود و هم برای داکر پراکسی تعریف کرده اید.
 
 سپس
 تنها کافیست کامند زیر را اجرا کنید.
   <pre dir="ltr">
docker-compose up -d
  </pre>
 
 
 ### راه اندازی nginx به عنوان `reverse proxy`
 
 در اولین قدم لازم هست که ادرسی `FQDN` ای که رکورد `A` آن به آیپی هاست اصلی که قصد نصب استک را بر روی آن دارید resolve  شود.
 
 در اینجا ما از دامنه `elk.test.ir` استفاده کرده ایم. 
 به این ترتیب هر جایی که این ادرس را مشاهده کردید منظور دامنه ای است که برای هاست در نظر گرفته اید و باید این ادرس را با ادرس خود عوض کنید.
 
 سپس با یوزر `root` وارد هاست شوید و این ریپو را clone کنید.
 وارد مسیر `/elk-dockerized/docker-compose/reverse-proxy` شوید.
 
 سپس فایل `.env` را باز کرده و مقادیر `domains` و `email` را با مقادیر مربوط به خود تغییر دهید.
 
 حال باید فایل کانفیگ nginx که در مسیر `elk-dockerized/docker-compose/reverse-proxy/data/nginx/app.conf` قرار دارد را با دامنه جدید آپدیت کنید.
 دامنه خود را در کامند زیر جایگذاری و 
 اجرا کنید:
 <pre dir="ltr">
 cd elk-dockerized/docker-compose/reverse-proxy/
 sed -i 's/elk.test.ir/YOUR_DOMAIN/g' ./data/nginx/app.conf
 </pre>
 
 اسکریپتی برای راه اندازی و انجام مراحل دریافت گواهی `SSL` تهیه شده که از آن کمک میگیریم. 
 
  <pre dir="ltr">
./init-letsencrypt.sh
# put y to the first question.
 </pre>
 
 ---
 ##  راه اندازی `Agent` ها
</div>
