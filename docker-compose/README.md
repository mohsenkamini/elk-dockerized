<div dir="rtl">
 
# مقدمه

 این ریپازیتوری جهت راه اندازی و نصب استک elk 
 تهیه شده است. 
 elk
 ابزاری برای مدیریت متمرکز log های سرویس ها و سرور های شماست.
 
نوشته شده توسط _محسن کربلائی امینی_  |  نئورکلود  |  سپتامبر 2021
 
 # چکیده
 
 نصب راه اندازی این استک را به دو قسمت مجزا تقسیم بندی میکنیم.
 
 1. [راه اندازی استک مرکزی](#راه-اندازی-استک-مرکزی)
 2.  [راه اندازی `Agent` ها ](#راه-اندازی-agent-ها)
 ---
 ## راه اندازی استک مرکزی
 
 در قسمت مرکزی استک منیجر اصلی `elasticsearch` و `kibana` حضور دارند.
 
 `kibana` نقشی مانند گرافانا را ایفا خواهد کرد و برای visualization مورد استفاده قرار خواهد گرفت. 
 لذا افزودن `replica` دیگر یا ورکر جدیدی را برای آن متصور نیستیم.
 
 `elasticsearch` هسته مرکزی و اصلی استک ماست و عملیات دریافت لاگ ها و انجام پراسس های مختلف روی آنها که در نهایت به آماده سازی لاگ ها 
 جهت `queriablity` و قابل نمایش بودن بر عهده ی الستیک و ورکر های آن میباشد.
 
 البته در سناریو فعلی این دو در کنار هم هستن, طبعا در اسکیل های بالاتر امکان اضافه کردن ورکر های الستیک روی نود های خارجی و دیگر طرح ها و دیزاین ها عملی ست. در سناریو  این ریپازیتوری در حال حاضر از یک هسته اصلی الستیک و یک ورکر روی همان نود استفاده میشود.
 
 ### توضیح دیزاین نود مرکزی ELK
 
 با استفاده از چارت زیر به آرشیتکت نود مرکزی میپردازیم. به شماره گذاری توجه کنید:
 
 ![ELK base diagram - numbered](https://user-images.githubusercontent.com/77579794/133118238-baf0f569-61bd-43a7-9e6d-3061d7e4037c.png)
 
 1. رکوئست های از طرف کاربر برای مشاهده پنل اصلی `kibana` روی پورت
 `443`
 برای دامنه که بعدا نشان خواهیم داد چطور تعیین و کانفیگ میشود ارسال میشود. این درخواست توسط `docker-proxy`
 برای کانتینر `nginx`
 که نقش `reverse proxy`
 را برای شبکه داخلی داکر با نام (`es_elastic`)
 ایفا میکند, ارسال میشود.
 
 2. کانتینر `nginx` به همراه کانتینر `certbot` وظیفه دریافت و تجدید گواهی `SSL` برای دامنه ما  را دارند
 بدین ترتیب هر رکوئستی که قرار باشد به داخل نتورک راه پیدا کند باید `https` باشد.
 
 3. رکوئستی که برای پورت 
 `443` ارسال شده بود
 توسط `nginx`
 به پورت 
 `5601`
 کانتینر `kibana` پراکسی میشود. 
 همان طور که در شکل مشخص هست, هیچ پورتی از کانتینر `kib01` روی هاست باز نمیباشد. و تنها راه ورودی از کانتینر `nginx` میباشد.
 به این ترتیب کاربر به پنل `kibana` دسترسی پیدا میکند.
 
 4. حال باید ببینیم که `log` ها یا `metric` های مختلف که از ریجن های مختلف, کانتینر ها و دیگر موارد جمع آوری میشود چگونه به دست `elasticsearch` مرکزی میرسد.
 هر کدام از `Agent` های مورد نظر, نظیر `filebeat` یا `logstash`
 باید درخواست ها و اطلاعات مربوطه جمع آوری شده را به پورت 
 `9200` 
 بر روی دامنه اصلی که به آیپی ماشین اصلی ریزالو شده بفرستند.
 
 اینجا هم مانند برقراری ارتباط کاربر با پنل `kibana` رکوئست از `reverse proxy` گذشته و به صورت `https`
 در مرحله **5** به دست `elasticsearch` یا کانتینر مرکزی که 
 `es01` باشد میرسد.
 
 6. در نهایت ارتباط بین `kibana` و `elasticsearch` در این مرحله با توجه به کانفیگ های صورت گرفته برای `kibana` انجام میگیرد.
 البته این ارتباط میتواند به دلیل وحود اقتضاعات خاص نظیر التزام وجود یک `CA` معتبر برای ارتباط `TLS` از بیرون هاست شکل بگیرد. یعنی کیبانا رکوئست خود را به خارج از نتورک داکر و روی پورت 9200 هاست بفرستد و از طریق `nginx` با الستیک سرچ ارتباط برقرار کند. درست مانند یک `Agent` خارجی
 
 - نکته : ارتباطات `https` ای در نتورک داخلی داکر به صورت `self signed`  صورت میپذیرد که کانفیگ های مربوطه به آن در لیست فایل های زیر صورت گرفته است.
  <pre dir="ltr">
  instances.yml
  docker-compose.yml
  create-certs.yml
  </pre>
 
 حال باید ببینیم که کانفیگ و راه اندازی هر بخش این استک چگونه صورت میگیرد.
 ### راه اندازی و کانفیگ elastic و kibana
 یکی از مهم ترین کانفیگ هایی که برای استک داریم, ورژن کامپوننت های الستیکی میباشد(الستیک, کیبانا و agent ها )
 تمامی این ورژن ها باید هماهنگ و یکسان باشند. این کانفیگ برای الستیک و کیبانا درون فایل `.env` در مسیر `/elk-dockerized/docker-compose` تعیین میشود. 
 در زمان نوشتن این داکیومنت آخرین ورژن الستیک 7.14.0 بوده و در صورت نیاز میتواند آن را تغییر دهید, اما مهم هست که بیاد داشته باشید این تغییر ورژن ممکن است در ادامه راه اندازی مسیر متفاوتی از آنچه در این داکیومنت میبینید برایتان رقم بزند.
 
 کانفیگ اصلی کیبانا در مسیر `elk-dockerized/docker-compose/data/kibana/kibana.yml` قابل دسترسی ست.
 دو دایرکتیو اصلی در این فایل وجود دارند که مربوط به دامنه شماست. برای تغییر آن دامنه خود را در کامند زیر جایگذاری کنید:
   <pre dir="ltr">
cd elk-dockerized/docker-compose/
sed -i 's/elk.test.ir/YOUR-DOMAIN/g' ./data/kibana/kibana.yml
  </pre>
 
 حالا زمان بالا آوردن اولیه کیبانا و الستیک سرچ میباشد.
 
 - نکته: پیشنهاد میشود قبل از اجرای این اسکریپت `docker login` کنید تا با ارور rate limit برخورد نکنید.
 
 - مطمئن شوید هم برای هاست خود و هم برای داکر پراکسی تعریف کرده اید.
 (به دلیل تحریم های ظالمانه :) )
 
 سپس
 مطمئن شوید که حداقل 4 گیگابایت رم به داکر اختصاص یافته است.
   <pre dir="ltr">
sysctl -w vm.max_map_count=262144
  </pre>
 حال راه اندازی certificate داخلی و بالا آوردن نهایی کانتینر هارا شروع میکنیم.
    <pre dir="ltr">
docker-compose -f create-certs.yml run --rm create_certs
#This one could take a while ...
docker-compose up -d
  </pre>
 
 در این مرحله kibana قادر به برقراری ارتباط با الستیک نیست. شما باید یوزر و پسورد مربوط به کیبانا را تولید کنید.
     <pre dir="ltr">
docker exec es01 /bin/bash -c "bin/elasticsearch-setup-passwords \\
auto --batch --url https://es01:9200"
  </pre>
 - نکته : حتما خروجی این دستور را ذخیره کنید و داشته باشید.

 حالا اطلاعات credential مربوط به یوزر `kibana_system` را داخل فایل `docker-compose.yml` و زیر سرویس `kib01` در دایرکتیو های مربوطه وارد کنید.
      <pre dir="ltr">
  kib01:
    .
    .
    .
    environment:
    .
    .
       ELASTICSEARCH_USERNAME: kibana_system
       ELASTICSEARCH_PASSWORD: CHANGEME
  </pre>
و دوباره اجرا کنید
 
<pre dir="ltr">
docker-compose up -d
</pre>
 
 ### راه اندازی nginx به عنوان `reverse proxy`
 
 در اولین قدم لازم هست که ادرسی `FQDN` ای که رکورد `A` آن به آیپی هاست اصلی که قصد نصب استک را بر روی آن دارید resolve  شود.
 
 در اینجا ما از دامنه `elk.test.ir` استفاده کرده ایم. 
 به این ترتیب هر جایی که این ادرس را مشاهده کردید منظور دامنه ای است که برای هاست در نظر گرفته اید و باید این ادرس را با ادرس خود عوض کنید.
 
 سپس با یوزر `root` وارد هاست شوید و این ریپو را clone کنید.
 وارد مسیر `/elk-dockerized/docker-compose/reverse-proxy` شوید.
 
 سپس فایل `.env` را باز کرده و مقادیر `domains` و `email` را با مقادیر مربوط به خود تغییر دهید.
 
 حال باید فایل کانفیگ nginx که در مسیر `elk-dockerized/docker-compose/reverse-proxy/data/nginx/app.conf` قرار دارد را با دامنه جدید آپدیت کنید.
برای این کار دامنه خود را در کامند`sed` زیر جایگذاری و 
 اجرا کنید:
 <pre dir="ltr">
 cd elk-dockerized/docker-compose/reverse-proxy/
 sed -i 's/elk.test.ir/YOUR_DOMAIN/g' ./data/nginx/app.conf
 </pre>
 سپس از
 اسکریپتی که برای راه اندازی و انجام مراحل دریافت گواهی `SSL` تهیه شده, کمک میگیریم. 
 و در نهایت کانتینر های مربوط به `reverse proxy` را آماده میکنیم.
  <pre dir="ltr">
./init-letsencrypt.sh
# put y to the first question.
# then compose up the containers to finalize the process
docker-compose up -d
 </pre>
 
 
 ### تایید نهایی راه اندازی استک
 
 برای اینکه از راه اندازی استک خود مطمئن شوید باید رکوئست های زیر را به دامنه تعیین شده ارسال کنید. میتوانید از مرورگر خود برای اینکار استفاده کنید.

 - `https://YOUR-DOMAIN:9200`
 
 از اطلاعات کاربر `elastic` که قبلا ذخیره کرده بودید استفاده کنید برای login کردن.
 
 خروجی باید اطلاعات مربوط به `elasticsearch` شما را نشان دهد.
  ![landing page 9200](https://user-images.githubusercontent.com/77579794/133146932-3accd565-6864-44b1-b3df-7163678bc09f.jpg)
 
 - `https://YOUR-DOMAIN`
 
  از اطلاعات کاربر `elastic` که قبلا ذخیره کرده بودید استفاده کنید برای login کردن.
 
پس از login وارد پنل کیبانا خواهید شد.
  ![landing page 443](https://user-images.githubusercontent.com/77579794/133146927-ed8a6218-9a24-4a6c-afa6-374d2a055291.jpg)
 
 ### تغییر لایسنس از trial به basic
 پس از ورود به پنل کیبانا از منوی سمت چپ به ترتیب زیر عمل کنید.
 
  <pre dir="ltr">
Stack Management > Stack > License Management > revert to basic
 </pre>
   ![license management](https://user-images.githubusercontent.com/77579794/133150316-fa8fa36a-f679-4b77-a066-0cc7371d1883.png)
 
 ---
 ##  راه اندازی `Agent` ها
بخش دوم راه اندازی این استک راه اندازی `Agent` ها میباشد که وظیفه اصلی جمع آوری و ارسال لاگ های برای استک مرکزی را برعهده دارند.
 
 در این سناریو ما از دو `Agent` به صورت containerized استفاده خواهیم کرد.
 
 1. `filebeat` برای جمع آوری لاگ های syslog هر سیستم.

 2. `logstash` برای جمع آوری لاگ کانتینر ها
 
 حال به جزئیات کانفیگ و راه اندازی هر کدام از ایجنت ها به صورت جداگانه میپردازیم:
 
 ### راه اندازی filebeat
 
 دیزاین کانتینر
 filebeat
 برای دریافت لاگ های هاست میزبان خود.
 در ادامه کار و کانفیگ ها دیاگرام توضیح خواهد داده شد.
  ![filebeat diagram](https://user-images.githubusercontent.com/77579794/133249252-cce2e73b-a2b4-4533-96a8-9464f15504c4.png)

 
مسیر فایل های کانفیگ و راه اندازی مربوطه به filebeat در مسیر `/elk-dockerized/docker-compose/filebeat`
 قرار دارد و هر مسیری در ادامه گفته میشود relative به این مسیر میباشد.
 
 برای هر host ای که قصد دارید لاگ های سیستمی آنرا دریافت کنید در ابتدا این ریپو را با یوزر روت روی آن host دریافت کنید و به مسیری در بالا گفته شده بروید.
 
 در ابتدا فایل compose مربوط به فایل بیت را مورد بررسی قرار میدهیم و بعد به فایل کانفیگ آن میپردازیم.
 
 برای ایجاد دسترسی های بیشتر برای یوزر filebeat داخل کانتینر, ایمیج مربوط به این سرویس در حد خیلی کمی شخصی سازی شده و در هنگام اجرای فایل کامپوز ابتدا ایمیج شخصی سازی شده آماده خواهد شد. 
 
 بخش مهم دیگر `bind-mount` تعریف شده برای دریافت لاگ های host ای ست که کانتینر بر روی آن قرار میگیرد که بدین صورت دسترسی به لاگ های سیستم میزبان برای کانتینر میسر میشود.
   <pre dir="ltr">
       volumes:
      - /var/log:/var/myhost.logs:ro
  </pre>
پس مسیر `/var/myhost.logs` در کانتینر در واقع محل بایند لاگ های سیستم میزبان میباشد. این مسیر باید در فایل کانفیگ فایلبیت تعریف شود.
 
 فایل کانفیگ اصلی فایل بیت در مسیر `data/filebeat/data01/filebeat.docker.yml` قرار دارد.
بهتره قبل از ادامه نگاهی به محتویات این فایل بیاندازیم:
  <pre dir="ltr">
filebeat.config:
  modules:
    path: ${path.config}/modules.d/*.yml
    reload.enabled: false
filebeat.modules:
  - module: system
    syslog:
      enabled: true
      var.paths: ["/var/myhost.logs/syslog*"]
    auth:
      enabled: true
      var.paths: ["/var/myhost.logs/auth.log*"]

setup.kibana.host: "https://elk.test.ir:443"
setup.kibana.protocol: "https"
setup.kibana.username: "kibana_system"
setup.kibana.password: "CHANGEME"

output.elasticsearch:
  hosts: https://elk.test.ir:9200
  username: elastic
  password: CHANGEME
 </pre>
بخش های مهم این کانفیگ:
 1. بخش `filebeat.modules`
 
همان طور که مشاهده میشود ماژول های syslog و auth لاگ های مورد نیاز خود را از مسیر های تعیین شده که لاگ های سیستم میزبان هستند دریافت, برداشت (harvest) و پراسس میکنند.
 
 2.  بخش `output.elasticsearch`
 
 در این بخش بعد از دریافت و عبور از module ها باید برای الستیک ارسال شوند که در این بخش کانفیگ و credentials مربوطه باید وارد شود.
 
 همین طور دایرکتیو های مربوطه با اطلاعات مربوط به kibana باید با اطلاعات جدید استک شما تغییر کنند.
 
 


</div>
